{% include "header.html" %}
<main class="container py-4">
    <!-- Header -->
    <div class="mb-4">
        <h2 class="h2 fw-bold mb-2">Catalogue des livres</h2>
        <p class="text-muted">Parcourez et empruntez des livres de la bibliothèque</p>

        <!-- Liens de navigation -->
        <div class="d-flex gap-2 mb-3">
            <a href="{{ url_for('catalogue') }}" class="btn btn-outline-primary btn-sm">Catalogue</a>
            <a href="{{ url_for('mes_emprunts') }}" class="btn btn-outline-secondary btn-sm">Mes Emprunts</a>
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Dashboard Admin</a>
            {% endif %}
        </div>
    </div>

    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Filtres -->
    <div class="card mb-4 p-3">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="search" class="form-label">Rechercher</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="ri-search-line"></i></span>
                    <input type="text" id="search" class="form-control" placeholder="Titre, auteur, ISBN...">
                </div>
            </div>
            <div class="col-md-3">
                <label for="category" class="form-label">Catégorie</label>
                <select id="category" class="form-select">
                    <option value="Toutes">Toutes les catégories</option>
                    <option value="Littérature">Littérature</option>
                    <option value="Sciences">Sciences</option>
                    <option value="Histoire">Histoire</option>
                    <option value="Fantasy">Fantasy</option>
                    <option value="Science-Fiction">Science-Fiction</option>
                    <option value="Philosophie">Philosophie</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Statut</label>
                <select id="status" class="form-select">
                    <option value="Tous">Tous les statuts</option>
                    <option value="disponible">Disponible</option>
                    <option value="emprunté">Emprunté</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Résultat -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <p id="bookCount" class="text-muted mb-0">{{ livres|length }} livre(s) trouvé(s)</p>

        {% if current_user.role == 'admin' %}
        <a href="{{ url_for('livres') }}" class="btn btn-primary">
            <i class="ri-book-add-line me-1"></i> Ajouter un livre
        </a>
        {% endif %}
    </div>

    <!-- Liste des livres -->
    <div class="row g-3" id="booksContainer">
        {% for livre in livres %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 book-card" data-titre="{{ livre.titre|lower }}"
            data-auteur="{{ livre.auteur|lower }}"
            data-categorie="{{ livre.categorie|lower if livre.categorie else 'non catégorisé' }}"
            data-statut="{{ 'disponible' if livre.disponible else 'emprunté' }}">

            <div class="card h-100 shadow-sm border">
                {% if livre.image_couverture %}
                <img src="{{ url_for('static', filename='images/couvertures/' + livre.image_couverture) }}"
                    class="card-img-top" alt="{{ livre.titre }}" style="height: 200px; object-fit: cover;">
                {% else %}
                <img src="{{ url_for('static', filename='images/default-book.jpg') }}" class="card-img-top"
                    alt="{{ livre.titre }}" style="height: 200px; object-fit: cover;">
                {% endif %}

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ livre.titre }}</h5>
                    <p class="card-text text-muted mb-1">{{ livre.auteur }}</p>
                    <p class="text-muted small mb-2">ISBN: {{ livre.isbn or 'N/A' }}</p>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-secondary">{{ livre.categorie or 'Non catégorisé' }}</span>
                        <span class="badge {% if livre.disponible %}bg-success{% else %}bg-danger{% endif %}">
                            {% if livre.disponible %}Disponible{% else %}Emprunté{% endif %}
                        </span>
                    </div>

                    <div class="d-flex justify-content-between text-muted small mb-3">
                        <span><i class="ri-map-pin-line me-1"></i>#{{ livre.id }}</span>
                        <span><i class="ri-calendar-line me-1"></i>{{ livre.annee_publication or 'N/A' }}</span>
                    </div>

                    <div class="mt-auto d-flex gap-2">
                        {% if livre.disponible %}
                        {% if livre.id not in livres_empruntes %}
                        <form method="POST" action="{{ url_for('emprunter_livre', livre_id=livre.id) }}"
                            class="d-inline flex-fill">
                            <button type="submit" class="btn btn-primary w-100">Emprunter</button>
                        </form>
                        {% else %}
                        <button class="btn btn-secondary w-100" disabled>Déjà emprunté</button>
                        {% endif %}
                        {% else %}
                        <button class="btn btn-outline-secondary w-100" disabled>Indisponible</button>
                        {% endif %}

                        <button class="btn btn-outline-secondary view-details-btn" data-bs-toggle="modal"
                            data-bs-target="#bookDetailsModal" data-livre-id="{{ livre.id }}"
                            data-livre-titre="{{ livre.titre }}" data-livre-auteur="{{ livre.auteur }}"
                            data-livre-isbn="{{ livre.isbn }}" data-livre-categorie="{{ livre.categorie }}"
                            data-livre-annee="{{ livre.annee_publication }}" data-livre-resume="{{ livre.resume }}"
                            data-livre-disponible="{{ livre.disponible }}"
                            data-livre-image="{% if livre.image_couverture %}{{ url_for('static', filename='images/couvertures/' + livre.image_couverture) }}{% else %}{{ url_for('static', filename='images/default-book.jpg') }}{% endif %}">
                            <i class="ri-eye-line"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if livres|length == 0 %}
    <div class="text-center py-5">
        <i class="ri-book-line display-1 text-muted"></i>
        <h4 class="text-muted mt-3">Aucun livre trouvé</h4>
        <p class="text-muted">Essayez de modifier vos critères de recherche</p>
    </div>
    {% endif %}

    <!-- Modal détails -->
    <div class="modal fade" id="bookDetailsModal" tabindex="-1" aria-labelledby="bookDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookDetailsModalLabel">Détails du livre</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <img id="modalBookImage" src="" class="img-fluid rounded" alt="Couverture du livre"
                                style="height: 300px; object-fit: cover;">
                        </div>
                        <div class="col-md-8">
                            <h4 id="modalBookTitle" class="mb-2"></h4>
                            <p id="modalBookAuthor" class="text-muted mb-1"></p>
                            <p id="modalBookIsbn" class="text-muted small mb-3"></p>
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-2">
                                    <span id="modalBookCategory" class="badge bg-secondary"></span>
                                    <span id="modalBookStatus" class="badge"></span>
                                </div>
                                <div class="d-flex justify-content-between text-muted small mb-3">
                                    <span><i class="ri-calendar-line me-1"></i><span id="modalBookYear"></span></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <h6>Résumé</h6>
                                <p id="modalBookSummary" class="small"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <form id="modalBorrowForm" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-primary" id="modalBorrowBtn">Emprunter</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search');
        const categorySelect = document.getElementById('category');
        const statusSelect = document.getElementById('status');
        const books = document.querySelectorAll('.book-card');
        const bookCount = document.getElementById('bookCount');

        function filterBooks() {
            const search = searchInput.value.toLowerCase();
            const category = categorySelect.value.toLowerCase();
            const status = statusSelect.value.toLowerCase();
            let visibleCount = 0;

            books.forEach(book => {
                const titre = book.dataset.titre;
                const auteur = book.dataset.auteur;
                const cat = book.dataset.categorie;
                const stat = book.dataset.statut;

                const matchesSearch = titre.includes(search) || auteur.includes(search);
                const matchesCategory = (category === 'toutes') || (cat === category);
                const matchesStatus = (status === 'tous') || (stat === status);

                if (matchesSearch && matchesCategory && matchesStatus) {
                    book.style.display = '';
                    visibleCount++;
                } else {
                    book.style.display = 'none';
                }
            });

            bookCount.textContent = `${visibleCount} livre(s) trouvé(s)`;
        }

        searchInput.addEventListener('input', filterBooks);
        categorySelect.addEventListener('change', filterBooks);
        statusSelect.addEventListener('change', filterBooks);
    });
</script>

{% include "footer.html" %}